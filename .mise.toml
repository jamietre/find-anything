[tools]
node = "24"
"cargo:cargo-watch" = "latest"

[hooks]
# Enable corepack after mise installs node
# The pnpm version is managed by package.json's packageManager field
postinstall = "corepack enable"

[settings]
experimental = true  # Enables hook support

[env]
# Optional: Adds node_modules/.bin to PATH for easier command running
_.path = ["./node_modules/.bin", "~/.cargo/bin"]

# Optional: Set up a task to install dependencies
[tasks.install]
description = "Install dependencies"
run = "pnpm install"
sources = ["pnpm-lock.yaml", "package.json"]
outputs = ["node_modules"]

# ── Rust server ───────────────────────────────────────────────────────────────

[tasks.server]
description = "Start the Rust API server, auto-rebuild on source changes (requires cargo-watch)"
run = "cargo watch -w crates -x 'run -p find-server -- --config config/server.toml'"

[tasks.server-once]
description = "Start the Rust API server (single run, no watching)"
run = "cargo run -p find-server -- --config config/server.toml"

[tasks.dev]
description = "Start Rust API + Vite dev server (full dev environment with live reload)"
run = """
# setsid puts cargo-watch in its own process group so that
# "kill -TERM -$API_PID" reaches cargo-watch AND all its children
# (cargo run, find-server).  Without this, kill only hits cargo-watch
# and find-server keeps running, holding port 8765.
setsid cargo watch -w crates -x 'run -p find-server -- --config config/server.toml' &
API_PID=$!
trap "kill -TERM -$API_PID 2>/dev/null" EXIT INT TERM
pnpm --dir web dev
"""

# ── Client / scanning ─────────────────────────────────────────────────────────

[tasks.scan]
description = "Incremental scan of all configured sources"
run = [
  "cargo build --workspace",
  "cargo run -p find-client --bin find-scan -- --config config/client.toml",
]

[tasks.scan-full]
description = "Full (non-incremental) scan of all configured sources"
run = [
  "cargo build --workspace",
  "cargo run -p find-client --bin find-scan -- --config config/client.toml --full",
]

# ── Web UI ────────────────────────────────────────────────────────────────────

[tasks.build-release]
description = "Build web UI then compile find-server release binary with embedded assets"
run = ["pnpm --dir web run build", "cargo build --release -p find-server"]

# ── Checks ────────────────────────────────────────────────────────────────────

[tasks.check]
description = "Type-check all Rust crates and the web UI"
run = ["cargo check --workspace", "pnpm --dir web check"]

# ── Admin ─────────────────────────────────────────────────────────────────────

[tasks.admin]
description = "Show inbox status (pending and failed files)"
run = "cargo run -p find-client --bin find-admin -- --config config/client.toml"

# ── Database management ───────────────────────────────────────────────────────

[tasks.clean-db]
description = "Delete all databases and content archives (requires re-scan)"
run = """
set -e
DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/find-anything"
if [ -d "$DATA_DIR" ]; then
  echo "Deleting: $DATA_DIR"
  rm -rf "$DATA_DIR"
  echo "✓ Database and content archives deleted"
  echo "Run 'mise scan' or 'mise scan-full' to rebuild the index"
else
  echo "No data directory found at: $DATA_DIR"
fi
"""
